#!/bin/sh

set -x

echo "[INFO] searching for configlet"

if [ -x configlet ]; then
  configlet_path=configlet # configlet globally installed
elif [ -x ./bin/configlet ]; then
  configlet_path=./bin/configlet # configlet in ./bin
else
  echo "[ERROR] configlet is needed to be installed globally or in ./bin/configlet to sync exercises before running generators (install script: ./bin/fetch-configlet)"
  exit 1
fi

# clone or update problem specification definition from master repository
PROBLEM_SPEC_REPO="https://github.com/exercism/problem-specifications.git"
PROBLEM_SPEC_DIR="problem-specifications"
test -d ../${PROBLEM_SPEC_DIR} && rm -rf ../${PROBLEM_SPEC_DIR}
pushd .. && git clone --depth 1 ${PROBLEM_SPEC_REPO} ${PROBLEM_SPEC_DIR} && popd 


echo "[INFO] updating cached 'problem-specifications' data..."
# run info command to update cached 'problem-specifications' data
$configlet_path info > /dev/null

failed_generators=""

github_token=$1

echo "[INFO] updating exercises"
for generator in ./exercises/practice/*/.meta/gen; do
  exercise=$(echo "${generator}" | cut -d/ -f4)
  echo "[INFO] updating ${exercise}"
  $configlet_path sync --offline --update -e "${exercise}"
  pushd $generator
  DFLAGS='-J=.' dub -q run < ../../../../../../${PROBLEM_SPEC_DIR}/exercises/${exercise}/canonical-data.json  > ../../source/${exercise}.d
  if [ $? -ne 0 ]; then 
    echo "[ERROR] failed to run generator for ${exercise}"
    failed_generators="${exercise} ${failed_generators}"
  fi
  popd 
done

if [ -n "${failed_generators}" ]
then
      echo "[ERROR] generator(s) failed, please manually re-run:"
      for generator in ${failed_generators}
      do
          echo "* ${generator}"
      done
      exit 1
fi

echo "[SUCCESS]: all generators finished successful"